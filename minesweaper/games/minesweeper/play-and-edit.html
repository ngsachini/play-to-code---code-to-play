<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minesweeper - Play & Edit</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --background-color: #f5f7fa;
            --panel-bg: #ffffff;
            --border-color: #e1e5eb;
            --text-color: #333333;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        @media (max-width: 768px) {
            .layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
        }

        .editor-panel {
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 12px 15px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-container {
            flex: 1;
            overflow: hidden;
        }

        .CodeMirror {
            height: 100%;
            font-size: 14px;
        }

        .preview-panel {
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        .preview-container {
            flex: 1;
            padding: 15px;
            overflow: auto;
        }

        #preview-frame {
            width: 100%;
            height: 100%;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        .controls-panel {
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 15px;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .toggle-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toggle-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .console-panel {
            background: var(--panel-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            height: 200px;
        }

        .console-header {
            padding: 12px 15px;
            background: var(--primary-color);
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-content {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .console-message {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }

        .console-log {
            color: #9cdcfe;
        }

        .console-warn {
            color: #ffcc00;
        }

        .console-error {
            color: #f48771;
        }

        .console-timestamp {
            color: #555;
            margin-right: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 8px 15px;
            background: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: #666;
        }

        .revision-history {
            margin-top: 10px;
        }

        .revision-list {
            max-height: 100px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px;
        }

        .revision-item {
            padding: 3px 5px;
            cursor: pointer;
            border-radius: 3px;
        }

        .revision-item:hover {
            background: var(--border-color);
        }

        .revision-item.active {
            background: var(--primary-color);
            color: white;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
            }
            
            .toggle-group {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Minesweeper - Play & Edit</h1>
            <p>Edit the code and see your changes in real-time</p>
        </header>

        <div class="layout">
            <div class="editor-panel">
                <div class="panel-header">
                    <span>HTML</span>
                </div>
                <div class="editor-container">
                    <textarea id="html-editor"></textarea>
                </div>
            </div>

            <div class="preview-panel">
                <div class="panel-header">
                    <span>Preview</span>
                </div>
                <div class="preview-container">
                    <iframe id="preview-frame" sandbox="allow-scripts"></iframe>
                </div>
            </div>

            <div class="editor-panel">
                <div class="panel-header">
                    <span>CSS</span>
                </div>
                <div class="editor-container">
                    <textarea id="css-editor"></textarea>
                </div>
            </div>

            <div class="editor-panel">
                <div class="panel-header">
                    <span>JavaScript</span>
                </div>
                <div class="editor-container">
                    <textarea id="js-editor"></textarea>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="toolbar">
                <button id="run-btn" class="btn btn-primary">â–¶ Run (Ctrl/Cmd + Enter)</button>
                <button id="save-btn" class="btn btn-success">ðŸ’¾ Save (Ctrl/Cmd + S)</button>
                <button id="reset-btn" class="btn btn-warning">â†º Reset to Original</button>
                <button id="download-btn" class="btn btn-secondary">â¬‡ Download Files</button>
                <button id="new-tab-btn" class="btn btn-secondary">â†— Open in New Tab</button>
                
                <div class="toggle-group">
                    <div class="toggle-item">
                        <input type="checkbox" id="live-update-toggle" checked>
                        <label for="live-update-toggle">Live Update</label>
                    </div>
                    <div class="toggle-item">
                        <input type="checkbox" id="autoplay-toggle">
                        <label for="autoplay-toggle">Autoplay on Edit</label>
                    </div>
                </div>
            </div>

            <div class="revision-history">
                <strong>Revision History:</strong>
                <div class="revision-list" id="revision-list"></div>
            </div>
        </div>

        <div class="console-panel">
            <div class="console-header">
                <span>Console Output</span>
                <button id="clear-console-btn" class="btn btn-danger" style="padding: 3px 8px; font-size: 12px;">Clear</button>
            </div>
            <div class="console-content" id="console-output"></div>
        </div>

        <div class="status-bar">
            <div id="status-message">Ready</div>
            <div id="last-saved">Last saved: Never</div>
        </div>
    </div>

    <script>
        // Game slug for localStorage
        const GAME_SLUG = 'minesweeper';
        
        // Revision history limit
        const MAX_REVISIONS = 10;
        
        // Debounce delay for live updates
        const DEBOUNCE_DELAY = 300;
        
        // Editor instances
        let htmlEditor, cssEditor, jsEditor;
        
        // Original code storage
        let originalCode = {
            html: '',
            css: '',
            js: ''
        };
        
        // Current code storage
        let currentCode = {
            html: '',
            css: '',
            js: ''
        };
        
        // Revision history
        let revisions = [];
        let currentRevisionIndex = -1;
        
        // Autoplay state
        let autoplayEnabled = false;
        let debounceTimer = null;
        
        // DOM Elements
        const previewFrame = document.getElementById('preview-frame');
        const consoleOutput = document.getElementById('console-output');
        const statusMessage = document.getElementById('status-message');
        const lastSavedElement = document.getElementById('last-saved');
        const revisionList = document.getElementById('revision-list');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded event fired');
            initializeEditors();
            console.log('Editors initialized');
            await loadOriginalCode();
            console.log('Original code loaded');
            loadSavedCode();
            console.log('Saved code loaded');
            setupEventListeners();
            console.log('Event listeners set up');
            updatePreview();
            console.log('Preview updated');
            updateRevisionHistoryUI();
            updateStatusBar();
            console.log('Initialization complete');
        });
        
        // Initialize CodeMirror editors
        function initializeEditors() {
            htmlEditor = CodeMirror.fromTextArea(document.getElementById('html-editor'), {
                mode: 'htmlmixed',
                theme: 'material',
                lineNumbers: true,
                autoCloseTags: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                tabSize: 2,
                indentUnit: 2,
                extraKeys: {
                    'Ctrl-Space': 'autocomplete'
                }
            });
            
            cssEditor = CodeMirror.fromTextArea(document.getElementById('css-editor'), {
                mode: 'css',
                theme: 'material',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                tabSize: 2,
                indentUnit: 2
            });
            
            jsEditor = CodeMirror.fromTextArea(document.getElementById('js-editor'), {
                mode: 'javascript',
                theme: 'material',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                tabSize: 2,
                indentUnit: 2
            });
            
            // Set up editor change events
            htmlEditor.on('change', handleEditorChange);
            cssEditor.on('change', handleEditorChange);
            jsEditor.on('change', handleEditorChange);
        }
        
        // Load original code files
        async function loadOriginalCode() {
            try {
                console.log('Attempting to load original code files...');
                logToConsole('Loading original game files...', 'log');
                
                // Try to load files with better error handling
                const files = [
                    { name: 'index.html', type: 'html' },
                    { name: 'style.css', type: 'css' },
                    { name: 'script.js', type: 'js' }
                ];
                
                for (const file of files) {
                    try {
                        console.log(`Loading ${file.name}...`);
                        const response = await fetch(`./${file.name}`);
                        console.log(`Response for ${file.name}:`, response.status, response.statusText);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        const content = await response.text();
                        originalCode[file.type] = content;
                        console.log(`Successfully loaded ${file.name} (${content.length} characters)`);
                        logToConsole(`Loaded ${file.name} successfully (${content.length} characters)`, 'log');
                    } catch (fileError) {
                        console.error(`Failed to load ${file.name}:`, fileError);
                        logToConsole(`Failed to load ${file.name}: ${fileError.message}`, 'error');
                        // Use fallback content
                        switch (file.type) {
                            case 'html':
                                originalCode.html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minesweeper</title>
</head>
<body>
    <h1>Minesweeper Game</h1>
    <p>Game failed to load. Please check the console for errors.</p>
</body>
</html>`;
                                break;
                            case 'css':
                                originalCode.css = `body { font-family: Arial, sans-serif; }`;
                                break;
                            case 'js':
                                originalCode.js = `console.log('Minesweeper game failed to load');`;
                                break;
                        }
                    }
                }
                
                console.log('Finished loading original code files');
                console.log('Original code lengths - HTML:', (originalCode.html || '').length, 'CSS:', (originalCode.css || '').length, 'JS:', (originalCode.js || '').length);
                logToConsole('Finished loading original game files', 'log');
            } catch (error) {
                console.error('Error in loadOriginalCode:', error);
                logToConsole(`Error loading original code: ${error.message}`, 'error');
            }
        }
        
        // Load saved code from localStorage
        function loadSavedCode() {
            try {
                console.log('Loading saved code from localStorage...');
                logToConsole('Loading saved code from localStorage...', 'log');
                
                const saved = localStorage.getItem(`playground-${GAME_SLUG}-code`);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    currentCode = {...parsed};
                    
                    console.log('Setting editor values from saved code...');
                    console.log('HTML length:', (currentCode.html || originalCode.html || '').length);
                    console.log('CSS length:', (currentCode.css || originalCode.css || '').length);
                    console.log('JS length:', (currentCode.js || originalCode.js || '').length);
                    
                    if (htmlEditor && cssEditor && jsEditor) {
                        htmlEditor.setValue(currentCode.html || originalCode.html || '');
                        cssEditor.setValue(currentCode.css || originalCode.css || '');
                        jsEditor.setValue(currentCode.js || originalCode.js || '');
                        
                        console.log('Saved code loaded successfully');
                        logToConsole('Saved code loaded successfully', 'log');
                    } else {
                        console.error('Editors not initialized yet');
                        logToConsole('Error: Editors not initialized yet', 'error');
                    }
                } else {
                    // Load original code if no saved version exists
                    currentCode = {...originalCode};
                    
                    console.log('Setting editor values from original code...');
                    console.log('Original HTML length:', (originalCode.html || '').length);
                    console.log('Original CSS length:', (originalCode.css || '').length);
                    console.log('Original JS length:', (originalCode.js || '').length);
                    
                    if (htmlEditor && cssEditor && jsEditor) {
                        htmlEditor.setValue(originalCode.html || '');
                        cssEditor.setValue(originalCode.css || '');
                        jsEditor.setValue(originalCode.js || '');
                        
                        console.log('No saved code found, using original code');
                        logToConsole('No saved code found, using original code', 'log');
                    } else {
                        console.error('Editors not initialized yet');
                        logToConsole('Error: Editors not initialized yet', 'error');
                    }
                }
                
                // Load revision history
                const savedRevisions = localStorage.getItem(`playground-${GAME_SLUG}-revisions`);
                if (savedRevisions) {
                    revisions = JSON.parse(savedRevisions);
                    currentRevisionIndex = revisions.length - 1;
                    console.log(`Loaded ${revisions.length} revisions from localStorage`);
                    logToConsole(`Loaded ${revisions.length} revisions from localStorage`, 'log');
                } else {
                    // Create initial revision
                    saveRevision();
                    console.log('Created initial revision');
                    logToConsole('Created initial revision', 'log');
                }
            } catch (error) {
                console.error('Error loading saved code:', error);
                logToConsole(`Error loading saved code: ${error.message}`, 'error');
                // Fallback to original code
                currentCode = {...originalCode};
                if (htmlEditor && cssEditor && jsEditor) {
                    htmlEditor.setValue(originalCode.html || '');
                    cssEditor.setValue(originalCode.css || '');
                    jsEditor.setValue(originalCode.js || '');
                    saveRevision();
                }
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Button events
            document.getElementById('run-btn').addEventListener('click', updatePreview);
            document.getElementById('save-btn').addEventListener('click', saveCode);
            document.getElementById('reset-btn').addEventListener('click', resetToOriginal);
            document.getElementById('download-btn').addEventListener('click', downloadFiles);
            document.getElementById('new-tab-btn').addEventListener('click', openInNewTab);
            document.getElementById('clear-console-btn').addEventListener('click', clearConsole);
            
            // Toggle events
            document.getElementById('live-update-toggle').addEventListener('change', (e) => {
                if (!e.target.checked) {
                    clearTimeout(debounceTimer);
                }
            });
            
            document.getElementById('autoplay-toggle').addEventListener('change', (e) => {
                autoplayEnabled = e.target.checked;
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + S to save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    saveCode();
                }
                
                // Ctrl/Cmd + Enter to run
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    updatePreview();
                }
            });
            
            // Setup message listener for iframe console capture
            window.addEventListener('message', handleIframeMessage);
        }
        
        // Handle editor changes
        function handleEditorChange(editor) {
            // Update current code
            currentCode.html = htmlEditor.getValue();
            currentCode.css = cssEditor.getValue();
            currentCode.js = jsEditor.getValue();
            
            // Handle live update if enabled
            const liveUpdateEnabled = document.getElementById('live-update-toggle').checked;
            
            if (liveUpdateEnabled) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    updatePreview();
                }, DEBOUNCE_DELAY);
            }
            
            // Handle autoplay
            if (autoplayEnabled) {
                updatePreview();
            }
            
            updateStatusBar();
        }
        
        // Update the preview iframe
        function updatePreview() {
            try {
                statusMessage.textContent = 'Updating preview...';
                
                // Get current code
                const html = htmlEditor.getValue();
                const css = cssEditor.getValue();
                const js = jsEditor.getValue();
                
                // Create a simple template for the injected code
                const consoleOverrideScript = `
<script>
(function() {
    // Console override for capturing output
    const originalLog = console.log;
    const originalWarn = console.warn;
    const originalError = console.error;
    
    console.log = function() {
        window.parent.postMessage({
            type: 'console-log',
            args: Array.from(arguments),
            level: 'log'
        }, '*');
        originalLog.apply(console, arguments);
    };
    
    console.warn = function() {
        window.parent.postMessage({
            type: 'console-log',
            args: Array.from(arguments),
            level: 'warn'
        }, '*');
        originalWarn.apply(console, arguments);
    };
    
    console.error = function() {
        window.parent.postMessage({
            type: 'console-log',
            args: Array.from(arguments),
            level: 'error'
        }, '*');
        originalError.apply(console, arguments);
    };
    
    window.onerror = function(message, source, lineno, colno, error) {
        window.parent.postMessage({
            type: 'console-error',
            message: message,
            source: source,
            lineno: lineno,
            colno: colno,
            error: error?.stack || error
        }, '*');
        return true;
    };
})();
<\/script>`;
                
                // Inject CSS and JS into HTML using a simpler approach
                let fullHtml = html;
                
                // Insert CSS before </head>
                if (fullHtml.includes('</head>')) {
                    fullHtml = fullHtml.replace('</head>', '<style>' + css + '</style></head>');
                } else {
                    // If no head tag, insert at the beginning
                    fullHtml = '<style>' + css + '</style>' + fullHtml;
                }
                
                // Insert JS before </body> or at the end
                if (fullHtml.includes('</body>')) {
                    fullHtml = fullHtml.replace('</body>', consoleOverrideScript + '<script>' + js + '</script></body>');
                } else {
                    // If no body tag, append at the end
                    fullHtml = fullHtml + consoleOverrideScript + '<script>' + js + '</script>';
                }
                
                // Write to iframe
                const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                doc.open();
                doc.write(fullHtml);
                doc.close();
                
                statusMessage.textContent = 'Preview updated';
            } catch (error) {
                statusMessage.textContent = 'Error updating preview';
                logToConsole(`Preview error: ${error.message}`, 'error');
            }
        }
        
        // Handle messages from iframe
        function handleIframeMessage(event) {
            // Security check - only accept messages from our iframe
            if (event.source !== previewFrame.contentWindow) {
                return;
            }
            
            const data = event.data;
            
            switch (data.type) {
                case 'console-log':
                    logToConsole(data.args.join(' '), data.level);
                    break;
                case 'console-error':
                    logToConsole(`${data.message} (${data.source}:${data.lineno}:${data.colno})`, 'error');
                    if (data.error) {
                        logToConsole(data.error, 'error');
                    }
                    break;
            }
        }
        
        // Log message to console UI
        function logToConsole(message, level = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `console-message console-${level}`;
            entry.innerHTML = `<span class="console-timestamp">${timestamp}</span>${message}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        // Clear console output
        function clearConsole() {
            consoleOutput.innerHTML = '';
        }
        
        // Save code to localStorage
        function saveCode() {
            try {
                // Update current code
                currentCode.html = htmlEditor.getValue();
                currentCode.css = cssEditor.getValue();
                currentCode.js = jsEditor.getValue();
                
                // Save to localStorage
                localStorage.setItem(`playground-${GAME_SLUG}-code`, JSON.stringify(currentCode));
                
                // Save revision
                saveRevision();
                
                // Update UI
                const now = new Date().toLocaleString();
                lastSavedElement.textContent = `Last saved: ${now}`;
                statusMessage.textContent = 'Code saved successfully';
                
                updateRevisionHistoryUI();
            } catch (error) {
                statusMessage.textContent = 'Error saving code';
                logToConsole(`Save error: ${error.message}`, 'error');
            }
        }
        
        // Save a revision
        function saveRevision() {
            const revision = {
                timestamp: new Date().toISOString(),
                code: {
                    html: htmlEditor.getValue(),
                    css: cssEditor.getValue(),
                    js: jsEditor.getValue()
                }
            };
            
            // If we're not at the end of the revision history, truncate it
            if (currentRevisionIndex < revisions.length - 1) {
                revisions = revisions.slice(0, currentRevisionIndex + 1);
            }
            
            // Add new revision
            revisions.push(revision);
            
            // Limit to MAX_REVISIONS
            if (revisions.length > MAX_REVISIONS) {
                revisions.shift();
            }
            
            // Update current index
            currentRevisionIndex = revisions.length - 1;
            
            // Save to localStorage
            localStorage.setItem(`playground-${GAME_SLUG}-revisions`, JSON.stringify(revisions));
        }
        
        // Reset to original code
        function resetToOriginal() {
            if (confirm('Are you sure you want to reset to the original code? All changes will be lost.')) {
                htmlEditor.setValue(originalCode.html);
                cssEditor.setValue(originalCode.css);
                jsEditor.setValue(originalCode.js);
                
                currentCode = {...originalCode};
                statusMessage.textContent = 'Reset to original code';
                updatePreview();
                saveRevision();
                updateRevisionHistoryUI();
            }
        }
        
        // Download files
        function downloadFiles() {
            try {
                // In a real implementation, you would create a ZIP file or provide individual downloads
                // For now, we'll just show an alert with the code
                alert('In a full implementation, this would download your HTML, CSS, and JavaScript files as a ZIP archive.');
                
                // Log to console for demonstration
                logToConsole('Download functionality would package your files here', 'log');
            } catch (error) {
                statusMessage.textContent = 'Error preparing download';
                logToConsole(`Download error: ${error.message}`, 'error');
            }
        }
        
        // Open preview in new tab
        function openInNewTab() {
            try {
                // Get current code
                const html = htmlEditor.getValue();
                const css = cssEditor.getValue();
                const js = jsEditor.getValue();
                
                // Inject CSS and JS into HTML using a simpler approach
                let fullHtml = html;
                
                // Insert CSS before </head>
                if (fullHtml.includes('</head>')) {
                    fullHtml = fullHtml.replace('</head>', '<style>' + css + '</style></head>');
                } else {
                    // If no head tag, insert at the beginning
                    fullHtml = '<style>' + css + '</style>' + fullHtml;
                }
                
                // Insert JS before </body> or at the end
                if (fullHtml.includes('</body>')) {
                    fullHtml = fullHtml.replace('</body>', '<script>' + js + '</script></body>');
                } else {
                    // If no body tag, append at the end
                    fullHtml = fullHtml + '<script>' + js + '</script>';
                }
                
                // Create blob and open in new tab
                const blob = new Blob([fullHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                
                statusMessage.textContent = 'Opened in new tab';
            } catch (error) {
                statusMessage.textContent = 'Error opening in new tab';
                logToConsole(`New tab error: ${error.message}`, 'error');
            }
        }
        
        // Update revision history UI
        function updateRevisionHistoryUI() {
            revisionList.innerHTML = '';
            
            revisions.forEach((revision, index) => {
                const item = document.createElement('div');
                item.className = `revision-item ${index === currentRevisionIndex ? 'active' : ''}`;
                const date = new Date(revision.timestamp);
                item.textContent = `${date.toLocaleTimeString()} - ${date.toLocaleDateString()}`;
                item.addEventListener('click', () => loadRevision(index));
                revisionList.appendChild(item);
            });
        }
        
        // Load a specific revision
        function loadRevision(index) {
            if (index >= 0 && index < revisions.length) {
                const revision = revisions[index];
                htmlEditor.setValue(revision.code.html);
                cssEditor.setValue(revision.code.css);
                jsEditor.setValue(revision.code.js);
                currentRevisionIndex = index;
                updateRevisionHistoryUI();
                updatePreview();
                statusMessage.textContent = `Loaded revision from ${new Date(revision.timestamp).toLocaleString()}`;
            }
        }
        
        // Update status bar
        function updateStatusBar() {
            // Could show more detailed status information here
            // For now, we'll just ensure it says "Ready" after operations
            setTimeout(() => {
                if (statusMessage.textContent.includes('...')) {
                    statusMessage.textContent = 'Ready';
                }
            }, 1000);
        }
    </script>
</body>
</html>